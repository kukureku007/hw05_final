# Yatube.
## 1. Общее описание

Проект Yatube - социальная сеть блогов для авторов. Авторы могут публиковать записи в виде текст+картинка. Автора могут подписываться друг на друга и следить за новыми публикациями. Записи могут аранжироваться по группам. Также можно комментировать посты друг друга. Реализована регистрация по email, восстановление/смена пароля.
Работа с медиа, статикой, csrf, файловый тестовый сервер электронной почты пагинация.  
Полная подготовка к деплою на сервер.  
## 2. Стек технологий

Django 2.2 - основной веб-фреймворк.  
python-dotenv - для хранения секретов отдельно от исходников.  
debug_toolbar - для отладки сайта, боевых sql-запросов.  
django_extensions - расширение инструментария Django и командной строки фреймворка.  
Pytest - реализованы unit-тесты для приложения posts.  
Bootstrap - адаптиная верстка для сайта, меню-гамбургер для мобильной версии.  
PostgreSQL 12.9 - База данных для продакшн-сервера.  
Gunicorn 20.1.0 - WSGI-сервер для организации работы связки веб-сервера nginx и Django.  
Nginx - веб-сервер, для обработки веб-запросов, работы с медиа и статикой.  

## 3. Приложения и зависимости моделей

# Приложение posts 
Приложение отвечает за основную логику проекта: создание/редактирование записей авторов, вывод записей конкретного автора/определенной группы, вывод конкретной записи с комментариями, подписки между авторами.  

example.org/ - домашняя страница, на которую выводятся все записи. На главной странице присутствуют табы переключения на страницу с записями авторов, на которых подписан текущий пользователь example.org/follow/.  
example.org/group/<slug:slug>/ - вывод постов определенной группы.  
example.org/profile/<str:username>/ - вывод всех записей автора.  
example.org/posts/<int:post_id>/ - вывод детальной информации записи, с возможностью: редактирования (если авторизованный пользователь - автор) и комментирования.  
example.org/create/ - создание записи, доступно для аутентифицированного пользователя.  
example.org/posts/<int:post_id>/edit/ - редактирование записи, доступно только автору записи.  
example.org/follow/ - вывод записей авторов, на которых пользователь подписан, доступно авторизованному пользователю.  
example.org/posts/<int:post_id>/comment/ - создание нового комментария, доступно в виде формы на странице записи.  
example.org/profile/<str:username>/follow/ - подписаться на автора, доступно в виде кнопки на странице автора.  
example.org/profile/<str:username>/unfollow/ - отписаться от автора, доступно в виде кнопки на странице автора.  

# Модели приложения

Author - дефолтный Django-класс User через get_user_model().  
Group - Группа, объединяющая по смыслу несколько записей. Создаётся админом, выбирается из списка при создании/редактировании записи. Имеет описание, название и сокращенное название-адрес slug.  
Post - Запись, создаваемая зарегистрированным пользователем. Имеет текст, автора, группу, картинку и дату создания.  
Возможно обратное получение записей:  
group.posts.all() - все записи группы.  
author.posts.all() - все записи автора.  
Comment - комментарий, который другой пользователь может оставить к записи. Имеет текст, автора, дату создания. Возможно обратное получение комментариев:  
author.comments.all() - все комментарии автора.  
post.comments.all() - все комментарии под постом.  
Follow - модель подписки пользователя (или другого автора) на автора. Есть следующие поля у модели: User - подписчик, related_name=follower - получить все отношения, где есть подписчик, потом необходимо отфильтровать по роли в этом отношении. Author - на кого подписан подписчик, related_name=following, получить все отношения, где есть автор, у которого есть подписчики, потом необходимо отфильтровать по роли в этом отношении. Ограничения: Отношение подписчик-автор уникально, пользователь не может подписаться на себя. 

# Приложение core
Содержит системные функции, такие как: контекстный процессор год - добавляет переменную year, доступную в контексте шаблонов.  
user_filter addclass() - добавляет атрибут для формы.  
Кастомные страницы ошибок - 404, 403, 500.  

# Приложение about
Статические страницы
example.org/author/ - информация об авторе проекта.  
example.org/tech/ - стек технологий, использованный при создании проекта.  

# Приложение users
Приложение, реализованное на стандартных View-функциях из пакета аутентификации django.contrib.auth.views.

example.org/signup/ - регистрация нового пользователя.  
example.org/logout/ - выход пользователя с сайта проекта.  
example.org/login/ - вход на сайт по логину/паролю.  
example.org/password_change/ - страница смены пароля.  
example.org/password_change/done/ - пароль успешно сменён.  
example.org/password_reset/ - сброс пароля через эмейл.  
example.org/password_reset/done/ - сброс пароля успешен.  
example.org/reset/<uidb64>/<token>/ - страница с токеном подтверждения, который высылается на почту при запросе сброса пароля.  
example.org/reset/done/ - пароль успешно сброшен.  

# Приложение yatube
Базовый пакет (приложение) проекта - который содержит настройки settings.py и корневой urls.py.

## 4. Установка и деплой проекта

1. Клонирование гит-репозитория
2. Создание виртуального окружения
```sh
pyhtno3 -m venv venv
```
3. Установка зависимостей
```sh
pip3 install -r requirements.txt.
```
4. Установка базы данных postgres (linux) 
```sh
sudo apt install postgresql postgresql-contrib -y
```
5. Создание базы данных
```sh
sudo -u postgres psql -c 'CREATE DATABASE DB_NAME;’
```
6. Создание пользователя для работы с БД  
```sh
sudo -u postgres psql -c 'CREATE USER POSTGRES_USER WITH ENCRYPTED PASSWORD   "POSTGRES_PASSWORD";'
```
7. Предоставление прав пользователю POSTGRES_USER к DB_NAME
```sh
sudo -u postgres psql -c 'GRANT ALL PRIVILEGES ON DATABASE yatube TO yatube_user;'
```
8. Заполнение файла project_dir/yatube/yatube/.env.  
Следующие данные необходимо заполнить:
DB_ENGINE=django.db.backends.postgresql
DB_HOST=127.0.0.1
DB_PORT=5432
#имя БД, пользователь и пароль
DB_NAME=
POSTGRES_USER=
POSTGRES_PASSWORD=
#секретный django ключ
SECRET_KEY=
#Домен, на котором будет расположен проект
DOMAIN_NAME= 
9. Выполнить миграции в базе данных: 
```sh
python3 manage.py migrate 
```
10. Настройка WSGI-сервера gunicorn (см. п.7 Файлы конфигураций)
11. Настройка веб-сервера Nginx (см. п.7 Файлы конфигураций)
12. Настройка Брандмауэра ufw
```sh
sudo ufw allow 'Nginx Full'
sudo ufw allow OpenSSH 
sudo ufw enable
```
13. Настройка DNS A-записи для доменного имени 
14. Настройка SSL

# Резервное копирование

Создание дампа базы данных.  
```sh
sudo -u postgres pg_dump DB_NAME > DB_NAME2.dump
```
Создание новой базы данных.  
```sh
sudo -u postgres psql -c 'create database DB_NAME2;'
```
Загрузка дампа в новую базу данных.  
```sh
sudo -u postgres psql -d DB_NAME2 -f DB_NAME2.dump
```

# Основные команды запуска

Запуск расширенной командной строки на сервере.
```sh
python3 manage.py shell_plus —print-sql
```
Запуск сервера.
```sh
sudo systemctl start gunicorn.
```
Перезапуск сервера.
```sh
sudo systemctl restart gunicorn
```
Запуск веб-сервера.
```sh
sudo systemctl start nginx 
```
Перезапуск веб-сервера.
```sh
sudo systemctl reload nginx
```


## 5. Дальнейшее развитие
- Добавление лайков с привязкой, кто лайкнул;
- Добавление хэштегов;
- Рефакторинг шаблонов;
- Поднятие почтового сервера;
- Удаление/редактирование комментарий;
- Ответы на комментарии;
- Упоминание записей, авторов, комментариев в тексте и комментариях.

## 6. Известные проблемы
- После логина не сбрасывается кэш главной страницы


## 7. Файлы конфигураций

Файл конфигурации WSGI-сервера gunicorn
Находится по адресу /etc/systemd/system/gunicorn.service

User - От какого пользователя запускать демона.  
WorkingDirectory - в какой папке лежит manage.py.  
BASE_DIR в ExecStart - корневая папка проекта.  
```
[Unit]
Description=gunicorn daemon 
After=network.target

[Service]
User=
WorkingDirectory=
ExecStart=BASE_DIR/venv/bin/gunicorn --bind 127.0.0.1:8000 yatube.wsgi:application

[Install]
WantedBy=multi-user.target
```

Файл конфигурации веб-сервера nginx.  
Находится по адресу /etc/nginx/sites-enabled/default.  

```
server {
	server_name IP_ADRESS DOMAIN
	
	location /static/ {
	    root /home/kukureku007/hw05_final/yatube/;
	}

	location /media/ {
		root /home/kukureku007/hw05_final/yatube/;
	}
	
	location / {
		include proxy_params;
		proxy_pass http://127.0.0.1:8000;
	}
}
```

by Michael Rudy, 2022
